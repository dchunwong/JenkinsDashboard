<link href="/css/test_stats.css" rel="stylesheet" type="text/css"></link>
<script src="/js/bower_components/d3/d3.min.js" charset="utf-8"></script>
<script src="/js/bower_components/rickshaw/rickshaw.min.js" charset="utf-8"></script>
<link rel="stylesheet" type="text/css" href="/js/bower_components/rickshaw/rickshaw.min.css">
{% extends "layout.html" %}
{% block body %}
<script>
var clearDate = {{clearDate}};
var test_data = [];
// Generate JSON from test_data
{% for test_dict in tests %}
    test_data[{{loop.index0}}] = {};
    idx = {{loop.index0}};
    {% for key, value in test_dict.items() %}
        {% if 'revision' in key %}
            test_data[idx].{{key}} = {};
            {% for subkey, subvalue in value.items() %}
                test_data[idx].{{key}}.{{subkey}} = "{{subvalue}}";
            {% endfor %}
        {% elif key == "test_list" %}
            test_data[idx].{{key}} = [];
            {% for test in value %}
                test_data[idx].{{key}}[{{loop.index0}}] = {};
                inneridx = {{loop.index0}};
                {% for subkey, subvalue in test.items() %}
                    test_data[idx].{{key}}[inneridx].{{subkey}} = "{{subvalue}}";
                    {% if subkey == "duration" %}
                        test_data[idx].{{key}}[inneridx].{{subkey}} = + test_data[idx].{{key}}[inneridx].{{subkey}};
                    {% endif %}
                {% endfor %}
            {% endfor %}
        {% else %}
            test_data[idx].{{key}} = "{{value}}";
            if(!isNaN(test_data[idx].{{key}})){
                test_data[idx].{{key}} = + test_data[idx].{{key}};
            }
        {% endif %}
    {% endfor %}
{% endfor %}
</script>
<div id="modal_container">
    <div id="modal_window">
    <p id="modal_close"><strong> X </strong></p>
    <hr></hr>        
    <div id="modal_content"></div>
    </div>
</div>
<h1>
    Test statistics for {{tests[0].test_list[0].test_name}}
</h1>
<div id="graph_container">
    <div id="chart_container">
        <h2 class="xlabel"> Results of {{tests[0].test_list[0].test_name}} Over Time </h2>
        <div id="yaxis"></div>
        <div id="chart"></div>
    </div>
    <span id="legend_container">
        <div id="legend"></div>
    </span>
    <div id="preview"></div>
</div>
<table id="resulttable">
{% if "gaia_revision" in tests[0].keys() %}
    <tr id="labelrow">
        <td class="tablehead"> Build </td>
        <td class="tablehead"> Results </td>
        <td class="tablehead"> Identifier</td>
        <td class="tablehead"> Build </br> Date </td>
        <td class="tablehead"> Firmware</br>Date </td>
        <td class="tablehead"> Firmware</br>Release</td>
        <td class="tablehead"> Firmware</br>Incremental </td>
        <td class="tablehead"> Gaia</br>Date </td>
        <td class="tablehead"> Gaia</br>Revision </td>
        <td class="tablehead"> Gecko</br>Build </td>
        <td class="tablehead"> Gecko</br>Revision </td>
        <td class="tablehead"> Gecko</br>Version </td>
    </tr>
    {% for test_dict in tests %}
        <tr>
            <td class="build">
                <a href="/job/{{test_dict.job}}/{{test_dict.build}}">
                    {{test_dict.build}}
                </a>
            </td>
            <td class="collapse result" data-idx={{loop.index0}}>
                {% for test in test_dict.test_list %}
                    <div class="{{test.result}}" data-idx={{loop.index0}}>
                    {% if test.result == "Passed" %}
                        ✔
                    {% elif test.result == "Skipped" %}
                        <strong>S</strong>
                    {% elif test.result == "Unexpected Pass" %}
                        <strong>UXP</strong>
                    {% else %}
                        {% if test.result == "Failure" %}
                            ✘
                        {% elif test.result == "Error" %}
                            <strong>E</strong>
                        {% elif test.result == "Expected Failure" %}
                            <strong>XF</strong>
                        {% endif %}
                    {% endif %}
                    </div>
                {% endfor %}
            </td>
            <td class="collapse identifier">
                {{ test_dict.identifier }}
            </td>
            <td class="collapse">
                {{test_dict.date|format_date}}
            </td>
            <td class="collapse">
                {{test_dict.firmware_date}}
            </td>
            <td class="collapse">
                {{test_dict.firmware_release}}
            </td>
            <td class="collapse break">
                {{test_dict.firmware_incremental}}
            </td>
            <td>
                {{test_dict.gaia_date}}
            </td>
            <td>
                <a href={{test_dict.gaia_revision.link}}>
                    {{test_dict.gaia_revision.revision}}
                </a>
            </td>
            <td>
                {{test_dict.gecko_build}}
            </td>
            <td>
                <a href={{test_dict.gecko_revision.link}}>
                    {{test_dict.gecko_revision.revision}}
                </a>
            </td>
            <td>
                {{test_dict.gecko_version}}
            </td>
        </tr>
    {% endfor %}
{% else %}
    <tr>
        <td class="tablehead"> Build </td>
        <td class="tablehead"> Results </td>
    </tr>
    {% for test_dict in tests %}
            <tr>
                <td>
                    <a href="../../{{test_dict.build}}">
                        {{test_dict.build}}
                    </a>
                </td>
                <td>
                {% for test in test_dict.test_list %}
                        <div class="{{test.result}}">
                        {% if test.result == "Passed" %}
                            ✔
                        {% elif test.result == "Skipped" %}
                            <strong>S</strong>
                        {% elif test.result == "Failure" %}
                            ✘
                        {% elif test.result == "Error" %}
                            <strong>E</strong>
                        {% elif test.result == "Expected Failure" %}
                            <strong>XF</strong>
                        {% elif test.result == "Unexpected Pass" %}
                            <strong>UXP</strong>
                        {% endif %}
                        </div>
                {% endfor %}
            </td>
            </tr>
    {% endfor %}
{% endif %}
</table>

<script src="/js/graphing.min.js"></script>
{% endblock %}
